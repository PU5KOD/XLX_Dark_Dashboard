#!/bin/bash

ARQUIVO="users_base.csv"

# ---------- Função para validar ausência de vírgulas ----------
validar_sem_virgulas() {
    local campo="$1"
    if [[ "$campo" == *","* ]]; then
        echo "Erro: O campo não pode conter vírgulas."
        return 1
    fi
    return 0
}

if [ ! -f "$ARQUIVO" ]; then
    echo "Erro: O arquivo $ARQUIVO não foi encontrado."
    exit 1
fi

echo "=== Inclusão / Alteração interativa de usuário ==="
echo

# ---------- DMRID (opcional, verificação imediata) ----------
LINHA_EXISTENTE=""

while true; do
    read -rp "DMRID (opcional, 7 dígitos): " DMRID
    validar_sem_virgulas "$DMRID" || continue

    if [ -z "$DMRID" ]; then
        break
    elif [[ "$DMRID" =~ ^[0-9]{7}$ ]]; then
        LINHA_EXISTENTE=$(awk -F',' -v dmr="$DMRID" '$1 == dmr {print NR; exit}' "$ARQUIVO")
        if [ -n "$LINHA_EXISTENTE" ]; then
            echo "DMRID já existe no arquivo (linha $LINHA_EXISTENTE)."
            sed -n "${LINHA_EXISTENTE}p" "$ARQUIVO"
            read -rp "Deseja ALTERAR este registro? (s/N): " RESP
            [[ "$RESP" =~ ^[sS]$ ]] || exit 0
        fi
        break
    else
        echo "Erro: DMRID inválido."
    fi
done

# ---------- Indicativo (obrigatório, 1–8 caracteres) ----------
while true; do
    read -rp "Indicativo (obrigatório, até 8 caracteres): " CALL

    validar_sem_virgulas "$CALL" || continue
    CALL=$(echo "$CALL" | tr '[:lower:]' '[:upper:]')

    if [[ "$CALL" =~ ^[A-Z0-9]{1,8}$ ]]; then
        LINHA_CALL=$(awk -F',' -v call="$CALL" '$2 == call {print NR; exit}' "$ARQUIVO")
        if [ -n "$LINHA_CALL" ]; then
            if [ -n "$LINHA_EXISTENTE" ] && [ "$LINHA_CALL" != "$LINHA_EXISTENTE" ]; then
                echo "Erro: Indicativo pertence a outro registro."
                exit 1
            fi
            LINHA_EXISTENTE="$LINHA_CALL"
            echo "Indicativo já existe no arquivo (linha $LINHA_EXISTENTE)."
            sed -n "${LINHA_EXISTENTE}p" "$ARQUIVO"
            read -rp "Deseja ALTERAR este registro? (s/N): " RESP
            [[ "$RESP" =~ ^[sS]$ ]] || exit 0
        fi
        break
    else
        echo "Erro: Indicativo inválido (somente A-Z e 0-9, até 8 caracteres)."
    fi
done

# ---------- Primeiro nome ----------
while true; do
    read -rp "Primeiro nome (obrigatório): " NOME
    validar_sem_virgulas "$NOME" || continue
    [ -n "$NOME" ] && break
done

# ---------- Sobrenome (opcional) ----------
while true; do
    read -rp "Sobrenome (opcional): " SOBRENOME
    validar_sem_virgulas "$SOBRENOME" || continue
    break
done

# ---------- Cidade ----------
while true; do
    read -rp "Cidade (obrigatório): " CIDADE
    validar_sem_virgulas "$CIDADE" || continue
    [ -n "$CIDADE" ] && break
done

# ---------- Estado ----------
while true; do
    read -rp "Estado (obrigatório): " ESTADO
    validar_sem_virgulas "$ESTADO" || continue
    [ -n "$ESTADO" ] && break
done

# ---------- País ----------
while true; do
    read -rp "País (obrigatório): " PAIS
    validar_sem_virgulas "$PAIS" || continue
    [ -n "$PAIS" ] && break
done

# ---------- Montagem da linha ----------
NOVA_LINHA="${DMRID},${CALL},${NOME},${SOBRENOME},${CIDADE},${ESTADO},${PAIS}"

echo
echo "Linha final:"
echo "$NOVA_LINHA"
echo
read -rp "Confirmar gravação? (s/N): " CONFIRMA

[[ "$CONFIRMA" =~ ^[sS]$ ]] || exit 0

# ---------- Escrita no CSV ----------
if [ -n "$LINHA_EXISTENTE" ]; then
    sed -i "${LINHA_EXISTENTE}s~.*~$NOVA_LINHA~" "$ARQUIVO"
    echo "Registro alterado com sucesso."
else
    echo "$NOVA_LINHA" >> "$ARQUIVO"
    echo "Registro adicionado com sucesso."
fi
